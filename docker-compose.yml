services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:8080:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - smarthome-network
    # Security: resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    # Security: don't allow privilege escalation
    security_opt:
      - no-new-privileges:true
    # tmpfs Ğ´Ğ»Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ nginx Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
      - /var/log/nginx
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - PORT=5000
      - BOT_TOKEN=${BOT_TOKEN:?BOT_TOKEN environment variable is required}
      - BOT_INTERNAL_URL=${BOT_INTERNAL_URL:-http://bot:8081}
      - REPORT_BOT_SECRET=${REPORT_BOT_SECRET:?REPORT_BOT_SECRET environment variable is required}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-}
      - SKIP_AUTH_VALIDATION=${SKIP_AUTH_VALIDATION:-false}
      - RATE_LIMIT_DEFAULT=60 per minute
      - RATE_LIMIT_AUTH=10 per minute
    volumes:
      - backend_data:/app/instance  # Persist SQLite database
      - backend_uploads:/app/uploads  # Persist uploads
    networks:
      - smarthome-network
    # Security: resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    # Security: don't allow privilege escalation
    security_opt:
      - no-new-privileges:true
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    environment:
      - BOT_TOKEN=${BOT_TOKEN:?BOT_TOKEN environment variable is required}
      - WEBAPP_URL=${WEBAPP_URL:?WEBAPP_URL environment variable is required}
      - API_URL=http://backend:5000/api
      - REPORT_BOT_SECRET=${REPORT_BOT_SECRET:?REPORT_BOT_SECRET environment variable is required}
      - BOT_INTERNAL_PORT=8081
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - smarthome-network
    # Security: resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    # Security: don't allow privilege escalation
    security_opt:
      - no-new-privileges:true
    # Restart policy
    restart: unless-stopped

# Named volumes for data persistence
volumes:
  backend_data:
    driver: local
  backend_uploads:
    driver: local

# Network for inter-service communication
networks:
  smarthome-network:
    driver: bridge

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ˜ ĞŸĞ Ğ—ĞĞŸĞ£Ğ¡ĞšĞ£
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# ğŸš€ ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ Ğ—ĞĞŸĞ£Ğ¡Ğš (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ):
#    ./start-with-ngrok.sh
#
#    Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸:
#    1. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ ngrok
#    2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ HTTPS URL
#    3. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ .env Ñ„Ğ°Ğ¹Ğ»
#    4. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ Ğ²ÑĞµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
#
# ğŸ› ï¸ Ğ Ğ£Ğ§ĞĞĞ™ Ğ—ĞĞŸĞ£Ğ¡Ğš:
#    1. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ngrok: ngrok http 8080
#    2. Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ HTTPS URL
#    3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ .env: cp env.example .env
#    4. Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ BOT_TOKEN Ğ¸ WEBAPP_URL Ğ² .env
#    5. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ: docker-compose up --build
#
# ğŸ›‘ ĞĞ¡Ğ¢ĞĞĞĞ’ĞšĞ:
#    ./stop-with-ngrok.sh
#    Ğ¸Ğ»Ğ¸: docker-compose down
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Ğ¢Ğ Ğ•Ğ‘ĞĞ’ĞĞĞ˜Ğ¯ Ğš Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ£
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ:
#   - CPU: 1-2 ÑĞ´Ñ€Ğ°
#   - RAM: 1-2 GB
#   - Ğ”Ğ¸ÑĞº: 5-10 GB
#   - ĞĞ¡: Linux (Ubuntu 20.04+ Ğ¸Ğ»Ğ¸ Debian 11+)
#   - Docker & Docker Compose
#
# Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğµ:
#   - CPU: 2-4 ÑĞ´Ñ€Ğ°
#   - RAM: 2-4 GB
#   - Ğ”Ğ¸ÑĞº: 20 GB SSD
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
